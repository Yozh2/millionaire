#!/usr/bin/env node
/**
 * Generate a static game registry index for the app bundle.
 * Reads per-game registry.ts files and emits a typed registryIndex.ts.
 */
import { readFileSync, readdirSync, writeFileSync, existsSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';
import ts from 'typescript';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const ROOT_DIR = join(__dirname, '..');
const GAMES_DIR = join(ROOT_DIR, 'src', 'games');
const OUTPUT_FILE = join(
  ROOT_DIR,
  'src',
  'app',
  'screens',
  'registry',
  'registryIndex.ts'
);

const toCjs = (source, filename) => {
  const result = ts.transpileModule(source, {
    fileName: filename,
    compilerOptions: {
      module: ts.ModuleKind.CommonJS,
      target: ts.ScriptTarget.ES2020,
    },
  });
  return result.outputText;
};

const loadRegistry = (filePath) => {
  const source = readFileSync(filePath, 'utf8');
  const compiled = toCjs(source, filePath);
  const module = { exports: {} };
  const require = () => {
    throw new Error('Unexpected require in registry module');
  };
  const fn = new Function('exports', 'module', 'require', compiled);
  fn(module.exports, module, require);
  return module.exports.registry;
};

const getGameDirs = () => {
  if (!existsSync(GAMES_DIR)) return [];
  return readdirSync(GAMES_DIR).filter((name) => {
    if (name.startsWith('.')) return false;
    const fullPath = join(GAMES_DIR, name);
    return existsSync(join(fullPath, 'registry.ts'));
  });
};

const entries = [];

for (const gameId of getGameDirs()) {
  const registryPath = join(GAMES_DIR, gameId, 'registry.ts');
  const registry = loadRegistry(registryPath) || {};
  const withId = registry.id ? registry : { ...registry, id: gameId };
  entries.push(withId);
}

entries.sort((a, b) => String(a.id).localeCompare(String(b.id)));

const output = `// Auto-generated by scripts/generate-game-registry.js.\n` +
  `// Do not edit manually.\n\n` +
  `import type { GameRegistry } from '@app/types';\n\n` +
  `export const GAME_REGISTRY_INDEX: GameRegistry[] = ${JSON.stringify(entries, null, 2)};\n`;

writeFileSync(OUTPUT_FILE, output);

console.log(`\nâœ¨ Generated registry index: ${OUTPUT_FILE}`);
console.log(`   Games: ${entries.map((entry) => entry.id).join(', ') || 'none'}\n`);
