<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click-to-Levitate Card (Spring + Smooth Tilt)</title>
  <style>
    :root {
      --card-w: 360px;

      /* Равновесная «высота парения» (отрицательная = вверх) */
      --hoverY: -16px;

      /* Постоянная левитация вокруг равновесия */
      --bob-range: 7px;
      --bob-period: 3.0s;

      /* Максимальный наклон к мыши */
      --tilt-max: 7deg;
    }

    /* Чтобы кастомные свойства анимировались корректно */
    @property --mainY {
      syntax: '<length>';
      inherits: true;
      initial-value: 0px;
    }
    @property --bobY {
      syntax: '<length>';
      inherits: true;
      initial-value: 0px;
    }
    @property --rx {
      syntax: '<angle>';
      inherits: true;
      initial-value: 0deg;
    }
    @property --ry {
      syntax: '<angle>';
      inherits: true;
      initial-value: 0deg;
    }

    @property --glare {
      syntax: '<number>';
      inherits: true;
      initial-value: 0;
    }

    @property --glareX {
      syntax: '<length>';
      inherits: true;
      initial-value: 0px;
    }

    @property --glareY {
      syntax: '<length>';
      inherits: true;
      initial-value: 0px;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background:
        radial-gradient(1200px 600px at 50% 20%, rgba(140, 170, 255, .18), transparent 60%),
        radial-gradient(900px 520px at 50% 85%, rgba(0, 255, 210, .10), transparent 60%),
        #0b0f1a;
      color: rgba(255,255,255,.88);
      font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
            Noto Sans, Arial;
    }

    .stack {
      display: grid;
      gap: 18px;
      place-items: center;
    }

    .cardWrap {
      appearance: none;
      border: 0;
      background: transparent;
      padding: 0;
      cursor: pointer;
      perspective: 900px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .cardWrap:focus-visible {
      outline: 2px solid rgba(255,255,255,.75);
      outline-offset: 10px;
    }

    .card {
      --mainY: 0px;
      --bobY: 0px;
      --rx: 0deg;
      --ry: 0deg;
      --glare: 0;
      --glareX: 0px;
      --glareY: 0px;

      width: var(--card-w);
      padding: 18px 18px;
      display: grid;
      gap: 10px;

      border-radius: 0;

      /* frosted glass */
      background: rgba(255, 255, 255, 0.14);
      color: rgba(12, 14, 18, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow:
        0 10px 26px rgba(0,0,0,.32),
        inset 0 1px 0 rgba(255,255,255,.45);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);

      position: relative;
      overflow: hidden;

      transform-style: preserve-3d;
      will-change: transform, box-shadow;

      transform:
        translateY(calc(var(--mainY) + var(--bobY)))
        rotateX(var(--rx))
        rotateY(var(--ry));

      transition: box-shadow 220ms cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* Диагональный блик, который усиливается при наклоне к правому-верхнему углу */
    .card::before {
      content: '';
      position: absolute;
      inset: -40%;
      pointer-events: none;

      background: linear-gradient(
        135deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.0) 26%,
        rgba(255,255,255,0.55) 38%,
        rgba(255,255,255,0.20) 48%,
        rgba(255,255,255,0.0) 60%,
        rgba(255,255,255,0) 100%
      );

      /* чуть «сдвигаем» блик в сторону наклона */
      transform: translate(var(--glareX), var(--glareY));
      opacity: calc(var(--glare) * 0.85);
      mix-blend-mode: screen;
      filter: blur(0.2px);
    }

    /* Лёгкая внутренняя виньетка, чтобы стекло читалось */
    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,0.22), rgba(255,255,255,0) 55%),
        radial-gradient(140% 130% at 70% 90%, rgba(0,0,0,0.12), rgba(0,0,0,0) 55%);
      opacity: 0.65;
    }

    /* чтобы контент был поверх псевдо-слоёв */
    .card > * {
      position: relative;
      z-index: 1;
    }

    .cardWrap.is-active .card {
      box-shadow:
        0 28px 70px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.55);
    }

    .title {
      font-weight: 750;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    .desc {
      color: rgba(16,19,26,.78);
    }

    .hint {
      color: rgba(16,19,26,.55);
      font-size: 13px;
    }

    .badge {
      display: inline-block;
      width: max-content;
      padding: 3px 8px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.04);
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    @media (prefers-reduced-motion: reduce) {
      .card { transition: none; }
    }
  </style>
</head>
<body>
  <div class="stack">
    <button class="cardWrap" type="button" aria-pressed="false" data-lev-card>
      <span class="card" aria-hidden="true">
        <span class="badge">Click to toggle</span>
        <span class="title">Клик → взлёт (пружина) → левитация</span>
        <span class="desc">Второй клик — мягкая посадка.</span>
        <span class="hint">Во время левитации води мышью — будет tilt</span>
      </span>
    </button>
  </div>

  <script>
    /*
      FIX for "Can't create duplicate variable":
      - весь код внутри IIFE (локальная область видимости)
      - плюс guard, если среда почему-то инжектит/перезапускает скрипт
    */

    (() => {
      // Guard от повторной инициализации в одной и той же странице
      if (window.__levitatingCardDemoInitialized) return;
      window.__levitatingCardDemoInitialized = true;

      const clamp = (v, a, b) => Math.min(b, Math.max(a, v));
      const lerp = (a, b, t) => a + (b - a) * t;

      // Пружина (second-order): a = -k(x - target) - c*v
      // Более «вязкая» настройка, чтобы взлёт не был резким.
      const spring = {
        k: 120,
        c: 26,
      };

      function initCard(wrap) {
        const card = wrap.querySelector('.card');
        const rootStyle = getComputedStyle(document.documentElement);

        const hoverY = parseFloat(rootStyle.getPropertyValue('--hoverY')) || -16; // px
        const bobRange = parseFloat(rootStyle.getPropertyValue('--bob-range')) || 7; // px
        const bobPeriod = parseFloat(rootStyle.getPropertyValue('--bob-period')) || 3.0; // s
        const tiltMax = parseFloat(rootStyle.getPropertyValue('--tilt-max')) || 7; // deg

        // Динамика высоты
        let isActive = false;
        let y = 0;
        let v = 0;
        let targetY = 0;
        let wantedY = 0;

        // Левитация
        let bobPhase = 0;
        let bobAmp = 0;
        let bobAmpTarget = 0;

        // Tilt (гладкий)
        let tiltX = 0;
        let tiltY = 0;
        let tiltXTarget = 0;
        let tiltYTarget = 0;
        let lastPointer = null;

        // Время / loop
        let lastT = performance.now();
        let rafId = null;

        const setVars = () => {
          card.style.setProperty('--mainY', `${y.toFixed(3)}px`);
          card.style.setProperty(
            '--bobY',
            `${(-Math.sin(bobPhase) * bobAmp).toFixed(3)}px`
          );
          card.style.setProperty('--rx', `${tiltX.toFixed(3)}deg`);
          card.style.setProperty('--ry', `${tiltY.toFixed(3)}deg`);

          // Блик: усиливается, когда наклон направлен «влево + вверх»
          // В этой системе знаков: tiltX > 0 означает курсор сверху, tiltY < 0 — слева.
          const tx = clamp((tiltX) / tiltMax, 0, 1);  // вверх
          const ty = clamp((-tiltY) / tiltMax, 0, 1); // влево
          const gRaw = tx * ty;
          const glare = Math.pow(gRaw, 0.85);

          // Сдвиг блика чуть в сторону наклона
          const shift = 28; // px
          const gx = (tiltY / tiltMax) * shift;
          const gy = (-tiltX / tiltMax) * shift;

          card.style.setProperty('--glare', `${glare.toFixed(3)}`);
          card.style.setProperty('--glareX', `${gx.toFixed(3)}px`);
          card.style.setProperty('--glareY', `${gy.toFixed(3)}px`);
        };

        const startLoop = () => {
          if (rafId != null) return;
          lastT = performance.now();

          const tick = (t) => {
            const dt = clamp((t - lastT) / 1000, 0, 0.02);
            lastT = t;

            // 1) Мягкая подача цели (убирает резкий старт)
            const tauTarget = 0.14;
            const alphaTarget = 1 - Math.exp(-dt / tauTarget);
            targetY = lerp(targetY, wantedY, alphaTarget);

            // 2) Пружина к targetY
            const a = (-spring.k * (y - targetY) - spring.c * v);
            v += a * dt;
            y += v * dt;

            // 3) Плавное включение амплитуды bob
            const tauBob = 0.65;
            const alphaBob = 1 - Math.exp(-dt / tauBob);
            bobAmp = lerp(bobAmp, bobAmpTarget, alphaBob);

            // 4) bob phase
            const omega = (Math.PI * 2) / bobPeriod;
            bobPhase += omega * dt;

            // 5) Tilt target (по последнему положению курсора)
            if (isActive && lastPointer) {
              const rect = card.getBoundingClientRect();
              const px = lastPointer.x - rect.left;
              const py = lastPointer.y - rect.top;
              const nx = (px / rect.width) * 2 - 1;
              const ny = (py / rect.height) * 2 - 1;

              const sx = Math.sign(nx) * Math.pow(Math.abs(nx), 0.85);
              const sy = Math.sign(ny) * Math.pow(Math.abs(ny), 0.85);

              tiltXTarget = clamp(-sy * tiltMax, -tiltMax, tiltMax);
              tiltYTarget = clamp(sx * tiltMax, -tiltMax, tiltMax);
            }

            // 6) Сглаживание tilt (каждый кадр)
            const tauTilt = 0.08;
            const alphaTilt = 1 - Math.exp(-dt / tauTilt);
            tiltX = lerp(tiltX, tiltXTarget, alphaTilt);
            tiltY = lerp(tiltY, tiltYTarget, alphaTilt);

            setVars();

            // Останов, когда всё затухло и не активно
            if (!isActive) {
              const still = Math.abs(y) < 0.05 && Math.abs(v) < 0.25 && bobAmp < 0.05;
              const tiltStill = Math.abs(tiltX) < 0.05 && Math.abs(tiltY) < 0.05;
              if (still && tiltStill) {
                y = 0; v = 0; targetY = 0; wantedY = 0;
                bobAmp = 0; bobAmpTarget = 0;
                tiltX = 0; tiltY = 0; tiltXTarget = 0; tiltYTarget = 0;
                setVars();
                rafId = null;
                return;
              }
            }

            rafId = requestAnimationFrame(tick);
          };

          rafId = requestAnimationFrame(tick);
        };

        const activate = () => {
          isActive = true;
          wrap.classList.add('is-active');
          wrap.setAttribute('aria-pressed', 'true');

          wantedY = hoverY;
          bobAmpTarget = bobRange;

          startLoop();
        };

        const deactivate = () => {
          isActive = false;
          wrap.classList.remove('is-active');
          wrap.setAttribute('aria-pressed', 'false');

          wantedY = 0;
          bobAmpTarget = 0;
          tiltXTarget = 0;
          tiltYTarget = 0;

          startLoop();
        };

        const toggle = () => {
          if (isActive) deactivate();
          else activate();
        };

        const onMove = (ev) => {
          lastPointer = { x: ev.clientX, y: ev.clientY };
        };

        const onLeave = () => {
          lastPointer = null;
          tiltXTarget = 0;
          tiltYTarget = 0;
        };

        wrap.addEventListener('click', toggle);
        wrap.addEventListener('pointermove', onMove);
        wrap.addEventListener('pointerleave', onLeave);

        wrap.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggle();
          }
        });

        setVars();

        // Тест-хук: для простых проверок в консоли
        return { toggle, get isActive() { return isActive; } };
      }

      // Инициализация карточки (один инстанс)
      const instances = Array.from(document.querySelectorAll('[data-lev-card]')).map(initCard);

      // Мини-набор тестов без фреймворка (в консоль). Не ломает демо.
      (function runSmokeTests() {
        const assert = (name, cond) => {
          if (!cond) throw new Error(`Test failed: ${name}`);
          console.log(`✓ ${name}`);
        };

        console.groupCollapsed('LevitatingCard smoke tests');
        try {
          assert('exactly 1 instance exists', instances.length === 1);

          const btn = document.querySelector('[data-lev-card]');
          assert('aria-pressed starts false', btn.getAttribute('aria-pressed') === 'false');  // toggle on
          btn.click();
          assert('aria-pressed becomes true after click', btn.getAttribute('aria-pressed') === 'true');

          // toggle off
          btn.click();
          assert('aria-pressed becomes false after second click', btn.getAttribute('aria-pressed') === 'false');

          // extra: third click returns to true
          btn.click();
          assert('aria-pressed becomes true again on third click', btn.getAttribute('aria-pressed') === 'true');

          // cleanup: back to false
          btn.click();
          assert('aria-pressed back to false after fourth click', btn.getAttribute('aria-pressed') === 'false');

        } finally {
          console.groupEnd();
        }
      })();
    })();
  </script>
</body>
</html>
